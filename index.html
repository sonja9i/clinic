<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>한의원 치료 현황판</title>
    
    <!-- 오류 발생 시 화면에 표시하는 스크립트 (가장 먼저 실행) -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            var div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(180,0,0,0.95);color:white;padding:40px;z-index:99999;font-family:sans-serif;overflow:auto;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;';
            div.innerHTML = '<h1 style="font-size:24px;margin-bottom:20px;">⚠️ 프로그램 실행 중 오류가 발생했습니다.</h1>' +
                            '<p style="font-size:18px;margin-bottom:10px;">' + msg + '</p>' +
                            '<div style="background:rgba(0,0,0,0.3);padding:20px;border-radius:8px;text-align:left;max-width:800px;width:100%;margin-top:20px;">' +
                            '<p style="margin:5px 0;opacity:0.8;">위치: ' + (url || 'unknown') + ':' + line + '</p>' +
                            '<pre style="white-space:pre-wrap;word-break:break-all;color:#ffcccc;">' + (error && error.stack ? error.stack : 'No stack trace') + '</pre>' +
                            '</div>' +
                            '<button onclick="location.reload()" style="margin-top:30px;padding:15px 30px;font-size:18px;border:none;background:white;color:#990000;border-radius:50px;cursor:pointer;font-weight:bold;">새로고침</button>';
            document.body.appendChild(div);
            return false;
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
      .no-select { user-select: none; }
      
      /* 로딩 애니메이션 */
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root" style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666;">
        <div class="loader"></div>
        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">프로그램을 불러오는 중입니다...</h2>
        <p>화면이 멈춰있다면 인터넷 연결을 확인해주세요.</p>
        <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.6;">(React, Tailwind 라이브러리 로드 필요)</p>
    </div>

    <script type="text/babel" data-presets="env,react">
        // 라이브러리 로드 체크
        if (!window.React || !window.ReactDOM) {
            throw new Error("React 라이브러리를 불러오지 못했습니다.\n인터넷 연결을 확인하거나 크롬/엣지 브라우저를 사용해주세요.");
        }

        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- ICONS ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Icons = {
            Activity: (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>,
            AlertCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            Ban: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></IconBase>,
            BedDouble: (props) => <IconBase {...props}><path d="M2 20v-8h20v8"/><path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/><path d="M12 4v6"/><path d="M2 18h20"/></IconBase>,
            BellRing: (props) => <IconBase {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/><path d="M4 2C2.8 3.7 2 5.7 2 8"/><path d="M22 8c0-2.3-.8-4.3-2-6"/></IconBase>,
            Calendar: (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            CheckCircle2: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>,
            ChevronDown: (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>,
            Clock: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            Droplets: (props) => <IconBase {...props}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></IconBase>,
            Edit3: (props) => <IconBase {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>,
            GripVertical: (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>,
            History: (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>,
            LayoutDashboard: (props) => <IconBase {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>,
            ListOrdered: (props) => <IconBase {...props}><line x1="10" x2="21" y1="6" y2="6"/><line x1="10" x2="21" y1="12" y2="12"/><line x1="10" x2="21" y1="18" y2="18"/><path d="M4 6h1v4"/><path d="M4 10h2"/><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/></IconBase>,
            MessageSquare: (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>,
            Plus: (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            RotateCcw: (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>,
            Search: (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>,
            Stethoscope: (props) => <IconBase {...props}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></IconBase>,
            StickyNote: (props) => <IconBase {...props}><path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/></IconBase>,
            Timer: (props) => <IconBase {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></IconBase>,
            Trash2: (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            User: (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            UserPlus: (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></IconBase>,
            Users: (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            X: (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            XCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconBase>,
        };

        const TreatmentStatus = {
            WAITING: 'WAITING',
            IN_PROGRESS: 'IN_PROGRESS',
            COMPLETED: 'COMPLETED',
            SKIPPED: 'SKIPPED'
        };

        const TREATMENTS = {
            DEFAULT: ['ICT', '건부항', '침', '핫팩'],
            OPTIONAL: ['추나', '소노', '충격파', '냉찜질']
        };

        const TOTAL_BEDS = 8;

        const generateDefaultTreatments = () => {
            return TREATMENTS.DEFAULT.map((name) => ({
                id: name + '-' + Date.now() + '-' + Math.random(),
                name,
                status: TreatmentStatus.WAITING,
                isOptional: false,
            }));
        };

        const createTreatment = (name, isOptional = false) => ({
            id: name + '-' + Date.now() + '-' + Math.random(),
            name,
            status: TreatmentStatus.WAITING,
            isOptional,
        });

        const getTreatmentDuration = (name) => {
            if (name.includes('ICT')) return 10 * 60 * 1000;
            if (name.includes('부항')) return 3 * 60 * 1000;
            if (name.includes('침')) return 10 * 60 * 1000;
            if (name.includes('핫팩')) return 10 * 60 * 1000;
            if (name.includes('냉찜질')) return 5 * 60 * 1000;
            if (name.includes('소노')) return 5.5 * 60 * 1000;
            if (name.includes('충격파')) return 5.5 * 60 * 1000;
            return 10 * 60 * 1000; 
        };

        const playAlertSound = (durationMs = 5000) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const now = ctx.currentTime;
                const masterGain = ctx.createGain();
                masterGain.connect(ctx.destination);
                masterGain.gain.value = 0.3; 
                const cycleDuration = 1.2;
                const cycles = Math.ceil((durationMs / 1000) / cycleDuration);
                for (let i = 0; i < cycles; i++) {
                    const startTime = now + (i * cycleDuration);
                    const osc1 = ctx.createOscillator();
                    const gain1 = ctx.createGain();
                    osc1.connect(gain1);
                    gain1.connect(masterGain);
                    osc1.type = 'sine';
                    osc1.frequency.setValueAtTime(659.25, startTime);
                    gain1.gain.setValueAtTime(0, startTime);
                    gain1.gain.linearRampToValueAtTime(0.8, startTime + 0.05);
                    gain1.gain.exponentialRampToValueAtTime(0.001, startTime + 0.6);
                    osc1.start(startTime);
                    osc1.stop(startTime + 0.6);

                    const osc2 = ctx.createOscillator();
                    const gain2 = ctx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(masterGain);
                    const dongTime = startTime + 0.4;
                    osc2.type = 'sine';
                    osc2.frequency.setValueAtTime(523.25, dongTime);
                    gain2.gain.setValueAtTime(0, dongTime);
                    gain2.gain.linearRampToValueAtTime(0.8, dongTime + 0.05);
                    gain2.gain.exponentialRampToValueAtTime(0.001, dongTime + 1.2);
                    osc2.start(dongTime);
                    osc2.stop(dongTime + 1.2);
                }
                setTimeout(() => { if(ctx.state !== 'closed') ctx.close(); }, durationMs + 1000);
            } catch (e) { console.error("Failed to play audio:", e); }
        };

        const TreatmentBadge = ({ treatment, bedId, onToggle, onUpdateName }) => {
            const [timeLeft, setTimeLeft] = useState(null);
            const [isTimeOver, setIsTimeOver] = useState(false);

            useEffect(() => {
                let interval;
                if (treatment.status === TreatmentStatus.IN_PROGRESS && treatment.startTime) {
                    const duration = getTreatmentDuration(treatment.name);
                    const updateTimer = () => {
                        const elapsed = Date.now() - (treatment.startTime || 0);
                        const diff = duration - elapsed;
                        if (diff <= 0) { setIsTimeOver(true); setTimeLeft(Math.abs(diff)); } 
                        else { setIsTimeOver(false); setTimeLeft(diff); }
                    };
                    updateTimer();
                    interval = window.setInterval(updateTimer, 1000);
                } else { setTimeLeft(null); setIsTimeOver(false); }
                return () => clearInterval(interval);
            }, [treatment.status, treatment.startTime, treatment.name]);

            const formatTime = (ms) => {
                const totalSeconds = Math.ceil(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return minutes + ':' + seconds.toString().padStart(2, '0');
            };

            const getStyles = () => {
                switch (treatment.status) {
                    case TreatmentStatus.IN_PROGRESS:
                        if (isTimeOver) return 'bg-red-500 text-white border-red-600 shadow-md animate-pulse';
                        return 'bg-green-100 text-green-800 border-green-300 ring-2 ring-green-200';
                    case TreatmentStatus.COMPLETED: return 'bg-blue-50 text-blue-700 border-blue-200';
                    case TreatmentStatus.SKIPPED: return 'bg-gray-800 text-gray-300 border-gray-700 decoration-slate-500';
                    default: return 'bg-red-100 text-red-700 border-red-200';
                }
            };

            const getIcon = () => {
                switch (treatment.status) {
                    case TreatmentStatus.IN_PROGRESS:
                        if (isTimeOver) return <Icons.BellRing className="w-4 h-4 mr-1.5 animate-bounce" />;
                        return <Icons.Timer className="w-4 h-4 mr-1.5 animate-pulse" />;
                    case TreatmentStatus.COMPLETED: return <Icons.CheckCircle2 className="w-4 h-4 mr-1.5" />;
                    case TreatmentStatus.SKIPPED: return <Icons.Ban className="w-4 h-4 mr-1.5" />;
                    default: return <Icons.Clock className="w-4 h-4 mr-1.5" />;
                }
            };

            const getLabel = () => {
                switch (treatment.status) {
                    case TreatmentStatus.IN_PROGRESS:
                        if (isTimeOver) return '종료 (+' + (timeLeft !== null ? formatTime(timeLeft) : '0:00') + ')';
                        return timeLeft !== null ? formatTime(timeLeft) : '진행중';
                    case TreatmentStatus.COMPLETED: return '완료';
                    case TreatmentStatus.SKIPPED: return '안함';
                    default: return '대기';
                }
            };

            const isCupping = treatment.name.includes('부항');
            const isHotPack = treatment.name.startsWith('핫팩');
            const isAcupuncture = treatment.name.startsWith('침');
            const isICT = treatment.name.startsWith('ICT');
            const isSono = treatment.name.startsWith('소노');
            const isShockwave = treatment.name.startsWith('충격파');
            const isDraggable = treatment.status === TreatmentStatus.WAITING;

            const handleDragStart = (e) => {
                if (!isDraggable) { e.preventDefault(); return; }
                e.dataTransfer.setData('application/json', JSON.stringify({ treatmentName: treatment.name, bedId: bedId }));
                e.dataTransfer.effectAllowed = 'copy';
            };

            const stopPropagation = (e) => e.stopPropagation();

            const toggleCuppingType = (e) => {
                e.stopPropagation(); e.preventDefault();
                const newType = treatment.name === '습부항' ? '건부항' : '습부항';
                if (onUpdateName) onUpdateName(treatment.id, newType);
            };

            const handleHotPackOptionChange = (e) => {
                const val = e.target.value;
                if (onUpdateName) onUpdateName(treatment.id, val ? '핫팩 + (' + val + ')' : '핫팩');
            };

            const handleAcupunctureOptionChange = (e) => {
                const val = e.target.value;
                if (onUpdateName) onUpdateName(treatment.id, val ? '침 + (' + val + ')' : '침');
            };

            const handleDetailInputChange = (e, baseName) => {
                const val = e.target.value;
                if (onUpdateName) onUpdateName(treatment.id, val ? baseName + ' : ' + val : baseName);
            };

            const handleInputKeyDown = (e) => { if (e.key === ' ') e.stopPropagation(); };

            const hotPackOption = isHotPack ? (treatment.name.match(/\((.*?)\)/)?.[1] || '') : '';
            const acupunctureOption = isAcupuncture ? (treatment.name.match(/\((.*?)\)/)?.[1] || '') : '';
            const ictDetail = isICT ? (treatment.name.split(' : ')[1] || '') : '';
            const sonoDetail = isSono ? (treatment.name.split(' : ')[1] || '') : '';
            const shockwaveDetail = isShockwave ? (treatment.name.split(' : ')[1] || '') : '';

            let displayName = treatment.name;
            if (isHotPack) displayName = '핫팩';
            if (isAcupuncture) displayName = '침';
            if (isICT) displayName = 'ICT';
            if (isSono) displayName = '소노';
            if (isShockwave) displayName = '충격파';

            const ACUPUNCTURE_OPTIONS = ["약침", "봉침", "태반", "라인", "천메"];
            const HOTPACK_OPTIONS = ["두타베드", "자기장", "자리로베게"];

            return (
                <div className="relative group select-none">
                    <div draggable={isDraggable} onDragStart={handleDragStart} className={`flex items-center justify-between w-full px-3 py-2.5 rounded-lg border-2 font-medium transition-all duration-200 ${getStyles()} ${isDraggable ? 'cursor-grab active:cursor-grabbing hover:shadow-md' : ''}`}>
                        <div className="flex items-center flex-1 flex-wrap gap-y-1">
                            {isDraggable && <Icons.GripVertical className="w-3 h-3 mr-1 text-current opacity-50" />}
                            {getIcon()}
                            <div className="flex items-center flex-wrap">
                                <span className={`mr-1 ${treatment.status === TreatmentStatus.SKIPPED ? 'line-through opacity-70' : ''}`}>{displayName}</span>
                                {isCupping && treatment.status === TreatmentStatus.WAITING && (
                                    <div role="button" onClick={toggleCuppingType} onMouseDown={stopPropagation} className={`ml-2 px-3 py-1.5 rounded-md text-xs font-bold border shadow-sm transition-all flex items-center cursor-pointer z-10 ${treatment.name === '습부항' ? 'bg-red-500 text-white border-red-600 ring-1 ring-red-300 hover:bg-red-600' : 'bg-white text-gray-400 border-gray-200 hover:border-red-300 hover:text-red-400'}`} title={treatment.name === '습부항' ? '습부항 적용됨' : '건부항 (클릭하여 습부항 변경)'}>
                                        <Icons.Droplets size={12} className={`mr-1.5 ${treatment.name === '습부항' ? '' : 'opacity-50'}`} /><span>습</span>
                                    </div>
                                )}
                                {isAcupuncture && treatment.status === TreatmentStatus.WAITING && (
                                    <div className="relative group/select ml-2 z-20" onClick={stopPropagation} onMouseDown={stopPropagation} onKeyDown={e => e.key === ' ' && e.stopPropagation()}>
                                        <select className="appearance-none bg-white/80 border border-gray-300 hover:border-blue-500 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none text-center font-bold text-gray-700 cursor-pointer rounded-md py-1.5 pl-3 pr-7 min-w-[5rem] text-xs shadow-sm transition-all" value={acupunctureOption} onChange={handleAcupunctureOptionChange}>
                                            <option value="">선택</option>{ACUPUNCTURE_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"><Icons.ChevronDown size={12} /></div>
                                    </div>
                                )}
                                {isAcupuncture && treatment.status !== TreatmentStatus.WAITING && acupunctureOption && <span className="ml-1 opacity-90">+ {acupunctureOption}</span>}
                                {isHotPack && treatment.status === TreatmentStatus.WAITING && (
                                    <div className="relative group/select ml-2 z-20" onClick={stopPropagation} onMouseDown={stopPropagation} onKeyDown={e => e.key === ' ' && e.stopPropagation()}>
                                        <select className="appearance-none bg-white/80 border border-gray-300 hover:border-blue-500 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none text-center font-bold text-gray-700 cursor-pointer rounded-md py-1.5 pl-3 pr-7 min-w-[5rem] text-xs shadow-sm transition-all" value={hotPackOption} onChange={handleHotPackOptionChange}>
                                            <option value="">선택</option>{HOTPACK_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"><Icons.ChevronDown size={12} /></div>
                                    </div>
                                )}
                                {isHotPack && treatment.status !== TreatmentStatus.WAITING && hotPackOption && <span className="ml-1 opacity-90">+ {hotPackOption}</span>}
                                {isICT && treatment.status === TreatmentStatus.WAITING && <input type="text" value={ictDetail} onChange={(e) => handleDetailInputChange(e, 'ICT')} onClick={stopPropagation} onMouseDown={stopPropagation} onKeyDown={handleInputKeyDown} placeholder="부위 입력" className="ml-2 bg-white/80 border-b-2 border-red-200 focus:border-red-500 hover:border-red-300 outline-none text-xs font-semibold px-2 py-0.5 w-24 text-gray-700 placeholder-red-300/70 transition-colors z-20" />}
                                {isICT && treatment.status !== TreatmentStatus.WAITING && ictDetail && <span className="ml-1 opacity-90 font-medium">: {ictDetail}</span>}
                                {(isSono || isShockwave) && treatment.status === TreatmentStatus.WAITING && (
                                    <div className="flex items-center ml-2 z-20" onClick={stopPropagation} onMouseDown={stopPropagation}>
                                        <Icons.Edit3 size={12} className="text-gray-400 mr-1" />
                                        <input type="text" value={isSono ? sonoDetail : shockwaveDetail} onChange={(e) => handleDetailInputChange(e, isSono ? '소노' : '충격파')} onKeyDown={handleInputKeyDown} placeholder="강도/부위" className="bg-white/80 border-b-2 border-red-200 focus:border-red-500 hover:border-red-300 outline-none text-xs font-semibold px-2 py-0.5 w-32 text-gray-700 placeholder-red-300/70 transition-colors" />
                                    </div>
                                )}
                                {(isSono && treatment.status !== TreatmentStatus.WAITING && sonoDetail) && <span className="ml-1 opacity-90 font-medium">: {sonoDetail}</span>}
                                {(isShockwave && treatment.status !== TreatmentStatus.WAITING && shockwaveDetail) && <span className="ml-1 opacity-90 font-medium">: {shockwaveDetail}</span>}
                            </div>
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); onToggle(treatment.id); }} className={`text-xs font-bold uppercase tracking-wider ml-2 flex-shrink-0 px-2 py-1 rounded transition-all hover:bg-white/20 active:scale-95 border border-transparent hover:border-black/5 ${treatment.status === TreatmentStatus.IN_PROGRESS && !isTimeOver ? 'text-lg text-green-800' : ''} ${treatment.status === TreatmentStatus.IN_PROGRESS && isTimeOver ? 'text-white' : ''} ${treatment.status !== TreatmentStatus.IN_PROGRESS ? 'opacity-80' : ''}`} title="상태 변경 (클릭)">{getLabel()}</button>
                    </div>
                </div>
            );
        };

        const BedCard = ({ bed, onUpdate, onAdmitPatient, getPatientRecord }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [inputValue, setInputValue] = useState(bed.patientName);
            const [isDragOver, setIsDragOver] = useState(false);
            const [hasAlarm, setHasAlarm] = useState(false);
            const prevAlarmRef = useRef(false);
            const inputRef = useRef(null);

            useEffect(() => { setInputValue(bed.patientName); }, [bed.patientName]);

            useEffect(() => {
                if (!bed.patientName) {
                    setHasAlarm(false); prevAlarmRef.current = false; return;
                }
                const checkAlarm = () => {
                    const isAlarming = bed.treatments.some(t => {
                        if (t.status === TreatmentStatus.IN_PROGRESS && t.startTime) {
                            return (Date.now() - t.startTime) >= getTreatmentDuration(t.name);
                        }
                        return false;
                    });
                    setHasAlarm(isAlarming);
                    if (isAlarming && !prevAlarmRef.current) playAlertSound(5000);
                    prevAlarmRef.current = isAlarming;
                };
                checkAlarm();
                const interval = setInterval(checkAlarm, 1000);
                return () => clearInterval(interval);
            }, [bed.treatments, bed.patientName]);

            const handleRegisterPatient = () => {
                const name = inputValue.trim();
                if (name && name !== bed.patientName) {
                    let treatments = generateDefaultTreatments();
                    let memo = '', treatmentArea = '';
                    if (getPatientRecord) {
                        const history = getPatientRecord(name);
                        if (history) {
                            memo = history.memo || '';
                            treatmentArea = history.treatmentArea || '';
                            if (history.treatmentNames && history.treatmentNames.length > 0) {
                                treatments = history.treatmentNames.map(tName => {
                                    const isDefault = TREATMENTS.DEFAULT.some(def => tName.startsWith(def));
                                    return createTreatment(tName, !isDefault);
                                });
                            }
                        }
                    }
                    onUpdate({ ...bed, patientName: name, memo, treatmentArea, treatments, startTime: Date.now() });
                } else if (!name) {
                    if (bed.patientName) handleClearBed();
                    else setIsEditing(false);
                    return;
                }
                setIsEditing(false);
            };

            const handleClearBed = () => {
                onUpdate({ ...bed, patientName: '', memo: '', treatments: [], startTime: undefined, treatmentArea: '' });
                setInputValue('');
                setIsEditing(false);
            };

            const startEditing = () => { setIsEditing(true); setTimeout(() => inputRef.current && inputRef.current.focus(), 10); };
            const handleMemoChange = (e) => onUpdate({ ...bed, memo: e.target.value });
            const handleTreatmentAreaChange = (e) => onUpdate({ ...bed, treatmentArea: e.target.value });

            const toggleTreatment = (treatmentId) => {
                const updatedTreatments = bed.treatments.map((t) => {
                    if (t.id === treatmentId) {
                        let nextStatus = t.status, startTime = t.startTime;
                        if (t.status === TreatmentStatus.WAITING) { nextStatus = TreatmentStatus.IN_PROGRESS; startTime = Date.now(); }
                        else if (t.status === TreatmentStatus.IN_PROGRESS) { nextStatus = TreatmentStatus.COMPLETED; startTime = undefined; }
                        else if (t.status === TreatmentStatus.COMPLETED) nextStatus = TreatmentStatus.SKIPPED;
                        else if (t.status === TreatmentStatus.SKIPPED) nextStatus = TreatmentStatus.WAITING;
                        return { ...t, status: nextStatus, startTime };
                    }
                    return t;
                });
                onUpdate({ ...bed, treatments: updatedTreatments });
            };

            const updateTreatmentName = (treatmentId, newName) => {
                onUpdate({ ...bed, treatments: bed.treatments.map(t => t.id === treatmentId ? { ...t, name: newName } : t) });
            };

            const addOptionalTreatment = (treatmentName) => {
                if (bed.treatments.some((t) => t.name === treatmentName)) { alert('이미 추가된 치료입니다.'); return; }
                onUpdate({ ...bed, treatments: [...bed.treatments, createTreatment(treatmentName, true)] });
            };

            const handleDragOver = (e) => { e.preventDefault(); if (!bed.patientName) setIsDragOver(true); };
            const handleDragLeave = () => setIsDragOver(false);
            const handleDrop = (e) => {
                e.preventDefault(); setIsDragOver(false);
                if (bed.patientName) return;
                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    if (data.type === 'CONSULTATION_PATIENT' && onAdmitPatient) onAdmitPatient(bed.id, data.name, data.id);
                } catch (err) {}
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') e.currentTarget.blur();
                else if (e.key === 'Escape') { setInputValue(bed.patientName); setIsEditing(false); }
            };

            const isOccupied = !!bed.patientName;
            const sortedTreatments = [...bed.treatments].sort((a, b) => {
                const getScore = (s) => (s === TreatmentStatus.IN_PROGRESS ? 0 : s === TreatmentStatus.WAITING ? 1 : s === TreatmentStatus.COMPLETED ? 2 : 3);
                return getScore(a.status) - getScore(b.status);
            });

            return (
                <div className={`flex flex-col h-full bg-white rounded-xl shadow-md transition-all duration-300 relative ${hasAlarm ? 'ring-4 ring-red-500 ring-opacity-60 shadow-red-200 border-red-500 z-10 animate-pulse' : ''} ${!hasAlarm && isOccupied ? 'border-t-4 border-blue-500 shadow-lg' : ''} ${!hasAlarm && !isOccupied ? 'border-t-4 border-gray-200 opacity-90' : ''} ${isDragOver ? 'ring-4 ring-blue-300 scale-[1.02] border-blue-400 opacity-100' : ''}`}>
                    {hasAlarm && <div className="absolute inset-0 bg-red-50 opacity-10 rounded-xl pointer-events-none" />}
                    <div className={`flex items-center gap-2 p-3 border-b rounded-t-lg transition-colors h-14 ${hasAlarm ? 'bg-red-100 border-red-200' : 'bg-gray-50 border-gray-100'}`}>
                        <div className={`w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full font-bold text-sm transition-colors ${hasAlarm ? 'bg-red-600 text-white animate-bounce' : (isOccupied ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-600')}`}>
                            {hasAlarm ? <Icons.AlertCircle size={18} /> : bed.id}
                        </div>
                        <div className="min-w-[80px] flex-shrink-0">
                            {isEditing ? (
                                <input ref={inputRef} type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} onBlur={handleRegisterPatient} onKeyDown={handleKeyDown} placeholder="이름" className="w-full bg-transparent border-b-2 border-blue-500 px-1 py-0.5 text-lg font-bold text-gray-900 focus:outline-none placeholder-gray-400" />
                            ) : (
                                <div className="truncate cursor-pointer" onClick={isOccupied ? startEditing : undefined}>
                                    {isOccupied ? (
                                        <div className="flex items-end hover:bg-gray-100/50 rounded px-1 -ml-1 transition-colors"><span className="text-lg font-bold text-gray-800 truncate leading-none pt-1">{bed.patientName}</span><span className="text-xs text-gray-500 ml-1 mb-0.5 leading-none">님</span></div>
                                    ) : (
                                        <span className={`text-sm font-medium ${hasAlarm ? 'text-red-800 font-bold' : 'text-gray-400'}`}>{hasAlarm ? '종료' : '빈 베드'}</span>
                                    )}
                                </div>
                            )}
                        </div>
                        {isOccupied && (
                            <div className="flex-grow min-w-0 flex items-center bg-yellow-50 px-2 py-1 rounded-md border border-yellow-100 group focus-within:border-yellow-300 focus-within:ring-1 focus-within:ring-yellow-200 transition-all">
                                <Icons.StickyNote className="w-3 h-3 text-yellow-500 mr-1.5 flex-shrink-0" />
                                <input type="text" value={bed.memo || ''} onChange={handleMemoChange} placeholder="메모..." className="w-full bg-transparent text-sm text-gray-700 placeholder-gray-400 focus:outline-none" />
                            </div>
                        )}
                        {isOccupied && !hasAlarm && !isEditing && (
                            <button onClick={(e) => { e.stopPropagation(); handleClearBed(); }} className="text-gray-400 hover:text-red-500 transition-colors p-1.5 rounded-full hover:bg-gray-200 flex-shrink-0 ml-auto" title="초기화"><Icons.RotateCcw size={16} /></button>
                        )}
                    </div>
                    <div className="p-4 flex-grow flex flex-col relative" onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}>
                        {!isOccupied && !isEditing ? (
                            <button onClick={startEditing} className={`flex-grow flex flex-col items-center justify-center py-8 rounded-lg border-2 border-dashed transition-all group ${isDragOver ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-200 text-gray-400 hover:text-blue-500 hover:bg-blue-50 hover:border-blue-300'}`}>
                                <Icons.User className={`w-12 h-12 mb-2 transition-transform ${isDragOver ? 'scale-125' : 'opacity-50 group-hover:scale-110'}`} />
                                <span className="font-medium">{isDragOver ? '환자 등록' : '환자 등록'}</span>
                                {isDragOver && <span className="text-xs mt-1">놓아서 등록하기</span>}
                            </button>
                        ) : (
                            <div className="flex flex-col h-full">
                                {!isOccupied && isEditing && <div className="flex-grow flex items-center justify-center text-gray-400"><span className="animate-pulse">이름 입력 후 Enter</span></div>}
                                {isOccupied && (
                                    <>
                                        <div className="mb-2"><input type="text" value={bed.treatmentArea || ''} onChange={handleTreatmentAreaChange} placeholder="치료 부위 (예: 허리, 어깨)" className="w-full px-3 py-2.5 rounded-lg border-2 border-gray-200 focus:border-blue-400 focus:outline-none font-medium text-gray-700 placeholder-gray-400 bg-gray-50 text-center transition-all focus:bg-white" /></div>
                                        <div className="space-y-2 flex-grow overflow-y-auto pr-1 custom-scrollbar">
                                            {sortedTreatments.map((t) => <TreatmentBadge key={t.id} treatment={t} bedId={bed.id} onToggle={toggleTreatment} onUpdateName={updateTreatmentName} />)}
                                            {bed.treatments.length === 0 && <p className="text-center text-gray-400 text-sm py-4">치료 항목이 없습니다.</p>}
                                        </div>
                                        <div className="mt-4 pt-3 border-t border-gray-100 grid grid-cols-2 gap-2">
                                            {TREATMENTS.OPTIONAL.map((opt) => (
                                                <button key={opt} onClick={() => addOptionalTreatment(opt)} className="flex items-center justify-center space-x-1 px-2 py-1.5 bg-white border border-blue-100 text-blue-600 rounded hover:bg-blue-50 text-xs font-semibold transition-colors shadow-sm"><Icons.Plus size={12} /><span>{opt}</span></button>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ChunaQueueCard = ({ queue, onUpdate }) => {
            const [inputValue, setInputValue] = useState('');
            const [, setTick] = useState(0);
            useEffect(() => { const t = setInterval(() => setTick(n=>n+1), 1000); return () => clearInterval(t); }, []);
            
            const getWaitTime = (joinedAt) => {
                const diff = Math.max(0, Date.now() - joinedAt);
                return Math.floor(diff / 60000) + ':' + Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            };
            
            const handleAdd = (e) => {
                e.preventDefault(); if(!inputValue.trim()) return;
                onUpdate({ ...queue, patients: [...queue.patients, { id: Date.now() + '-' + Math.random(), name: inputValue.trim(), joinedAt: Date.now() }] });
                setInputValue('');
            };

            return (
                <div className="flex flex-col h-full bg-white rounded-xl shadow-md border-t-4 border-purple-500 overflow-hidden">
                    <div className="flex items-center justify-between p-4 border-b border-gray-100 bg-purple-50">
                        <div className="flex items-center space-x-2"><div className="bg-purple-600 text-white p-1.5 rounded-lg"><Icons.Users size={16} /></div><span className="text-purple-900 font-bold">추나 대기실</span></div>
                        <div className="text-xs font-semibold text-purple-600 bg-purple-100 px-2 py-1 rounded-full">{queue.patients.length}명 대기</div>
                    </div>
                    <div className="p-4 border-b border-gray-100 bg-white">
                        <form onSubmit={handleAdd} className="relative"><input type="text" value={inputValue} onChange={e=>setInputValue(e.target.value)} placeholder="대기자 이름 추가" className="w-full pl-9 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-200 focus:border-purple-400 transition-all text-sm" /><Icons.UserPlus className="absolute left-3 top-2.5 text-gray-400 w-4 h-4" /></form>
                    </div>
                    <div className="flex-grow p-2 overflow-y-auto custom-scrollbar bg-gray-50/50">
                        {queue.patients.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-gray-400 space-y-2 min-h-[150px]"><Icons.Clock className="w-8 h-8 opacity-20" /><span className="text-sm">대기자가 없습니다</span></div> : 
                        <div className="space-y-2">{queue.patients.map(p => (
                            <div key={p.id} className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-gray-100 group hover:border-purple-200 transition-all">
                                <div className="flex items-center space-x-3"><div className="w-2 h-2 rounded-full bg-purple-400"></div><span className="font-bold text-gray-800">{p.name}</span></div>
                                <div className="flex items-center space-x-2"><div className="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded flex items-center"><Icons.Clock size={12} className="mr-1.5" />{getWaitTime(p.joinedAt)}</div><button onClick={() => onUpdate({ ...queue, patients: queue.patients.filter(pat => pat.id !== p.id) })} className="text-gray-300 hover:text-red-500 hover:bg-red-50 p-1.5 rounded transition-colors"><Icons.X size={16} /></button></div>
                            </div>
                        ))}</div>}
                    </div>
                </div>
            );
        };

        const ConsultationQueueCard = ({ queue, onUpdate }) => {
            const [inputValue, setInputValue] = useState('');
            const [, setTick] = useState(0);
            useEffect(() => { const t = setInterval(() => setTick(n=>n+1), 1000); return () => clearInterval(t); }, []);

            const getWaitTime = (joinedAt) => {
                const diff = Math.max(0, Date.now() - joinedAt);
                return Math.floor(diff / 60000) + ':' + Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            };
            
            const handleAdd = (e) => {
                e.preventDefault(); if(!inputValue.trim()) return;
                onUpdate({ ...queue, patients: [...queue.patients, { id: Date.now() + '-' + Math.random(), name: inputValue.trim(), joinedAt: Date.now() }] });
                setInputValue('');
            };

            const handleDragStart = (e, patient) => {
                e.dataTransfer.setData('application/json', JSON.stringify({ type: 'CONSULTATION_PATIENT', name: patient.name, id: patient.id }));
                e.dataTransfer.effectAllowed = 'move';
            };

            return (
                <div className="flex flex-col h-full bg-white rounded-xl shadow-md border-t-4 border-orange-500 overflow-hidden">
                    <div className="flex items-center justify-between p-3 border-b border-gray-100 bg-orange-50">
                        <div className="flex items-center space-x-2"><div className="bg-orange-500 text-white p-1.5 rounded-lg"><Icons.MessageSquare size={16} /></div><span className="text-orange-900 font-bold">상담 대기</span></div>
                        <div className="text-xs font-semibold text-orange-600 bg-orange-100 px-2 py-1 rounded-full">{queue.patients.length}명</div>
                    </div>
                    <div className="p-3 border-b border-gray-100 bg-white">
                        <form onSubmit={handleAdd} className="relative"><input type="text" value={inputValue} onChange={e=>setInputValue(e.target.value)} placeholder="상담 대기자 입력" className="w-full pl-8 pr-3 py-1.5 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-200 focus:border-orange-400 transition-all text-sm" /><Icons.UserPlus className="absolute left-2.5 top-2 text-gray-400 w-4 h-4" /></form>
                    </div>
                    <div className="flex-grow p-2 overflow-y-auto custom-scrollbar bg-gray-50/50">
                        {queue.patients.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-gray-400 space-y-1 min-h-[100px]"><Icons.Clock className="w-6 h-6 opacity-20" /><span className="text-xs">대기자가 없습니다</span></div> : 
                        <div className="space-y-2">{queue.patients.map(p => (
                            <div key={p.id} draggable onDragStart={(e) => handleDragStart(e, p)} className="flex items-center justify-between bg-white p-2.5 rounded-lg shadow-sm border border-gray-100 group hover:border-orange-200 transition-all cursor-grab active:cursor-grabbing hover:shadow-md">
                                <div className="flex items-center space-x-2"><Icons.GripVertical className="w-3 h-3 text-gray-300" /><div className="w-1.5 h-1.5 rounded-full bg-orange-400"></div><span className="font-bold text-gray-800 text-sm">{p.name}</span></div>
                                <div className="flex items-center space-x-2"><div className="text-xs font-mono text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded flex items-center"><Icons.Clock size={10} className="mr-1" />{getWaitTime(p.joinedAt)}</div><button onClick={() => onUpdate({ ...queue, patients: queue.patients.filter(pat => pat.id !== p.id) })} className="text-gray-300 hover:text-red-500 hover:bg-red-50 p-1 rounded transition-colors"><Icons.X size={14} /></button></div>
                            </div>
                        ))}</div>}
                    </div>
                </div>
            );
        };

        const DoctorQueueCard = ({ queue, onUpdate, onCompleteItem }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            const listRef = useRef(null);
            useEffect(() => { if (listRef.current) listRef.current.scrollTop = listRef.current.scrollHeight; }, [queue.length]);
            
            const handleDrop = (e) => {
                e.preventDefault(); setIsDragOver(false);
                try {
                    const data = e.dataTransfer.getData('application/json');
                    if (!data) return;
                    const { treatmentName, bedId } = JSON.parse(data);
                    onUpdate([...queue, { id: 'queue-' + Date.now() + '-' + Math.random(), treatmentName, bedId, addedAt: Date.now() }]);
                } catch (err) {}
            };

            const handleClearAll = () => { if (queue.length > 0 && confirm('대기 순서를 모두 지우시겠습니까?')) onUpdate([]); };

            return (
                <div className={`flex flex-col h-full bg-white rounded-xl shadow-md border-t-4 border-indigo-500 overflow-hidden transition-all relative ${isDragOver ? 'ring-4 ring-indigo-200 scale-[1.02]' : ''}`} onDragOver={(e)=>{e.preventDefault();setIsDragOver(true)}} onDragLeave={()=>setIsDragOver(false)} onDrop={handleDrop}>
                    <div className="flex items-center justify-between p-4 border-b border-gray-100 bg-indigo-50">
                        <div className="flex items-center space-x-2"><div className="bg-indigo-600 text-white p-1.5 rounded-lg"><Icons.Stethoscope size={16} /></div><span className="text-indigo-900 font-bold">원장 치료 순서</span></div>
                        <div className="flex items-center space-x-2"><div className="text-xs font-semibold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full">{queue.length}명</div>{queue.length > 0 && <button onClick={handleClearAll} className="text-gray-400 hover:text-red-500 transition-colors p-1"><Icons.Trash2 size={16} /></button>}</div>
                    </div>
                    <div ref={listRef} className="flex-grow p-3 overflow-y-auto custom-scrollbar bg-slate-50 relative">
                        {queue.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-gray-400 space-y-2 min-h-[150px] border-2 border-dashed border-gray-200 rounded-lg bg-white/50"><Icons.ListOrdered className="w-10 h-10 opacity-20" /><div className="text-center"><span className="text-sm font-bold block text-gray-500">치료 순서가 비어있습니다</span><span className="text-xs opacity-70">베드에서 침/부항을 드래그하세요</span></div></div> : 
                        <div className="space-y-2 pb-2">{queue.map((item, index) => (
                            <div key={item.id} className="flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-gray-200 group hover:border-indigo-300 hover:shadow-md transition-all">
                                <div className="flex items-center space-x-3 overflow-hidden"><div className="flex-shrink-0 flex items-center justify-center w-8 h-8 bg-indigo-600 text-white rounded-lg text-lg font-bold shadow-sm">{index + 1}</div><div className="flex flex-col truncate"><span className="font-bold text-gray-800 text-xl truncate">{item.treatmentName} <span className="text-indigo-600">({item.bedId})</span></span></div></div>
                                <button onClick={() => onCompleteItem(item)} className="flex-shrink-0 text-gray-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors ml-2"><Icons.X size={20} /></button>
                            </div>
                        ))}</div>}
                        {isDragOver && <div className="absolute inset-0 bg-indigo-50/90 flex flex-col items-center justify-center backdrop-blur-sm z-20 rounded-lg border-2 border-dashed border-indigo-400 m-2 pointer-events-none"><Icons.Stethoscope className="w-12 h-12 text-indigo-500 mb-2 animate-bounce" /><span className="text-indigo-600 font-bold text-xl">여기에 놓아주세요</span></div>}
                    </div>
                </div>
            );
        };

        const HistoryView = ({ logs, onDelete }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedDate, setSelectedDate] = useState('');

            const filteredLogs = useMemo(() => {
                return logs.filter(log => {
                    const matchesSearch = log.patientName.toLowerCase().includes(searchTerm.toLowerCase()) || (log.memo && log.memo.toLowerCase().includes(searchTerm.toLowerCase())) || (log.treatmentArea && log.treatmentArea.toLowerCase().includes(searchTerm.toLowerCase()));
                    let matchesDate = true;
                    if (selectedDate) {
                        const logDate = new Date(log.date);
                        matchesDate = logDate.getFullYear() + '-' + String(logDate.getMonth() + 1).padStart(2, '0') + '-' + String(logDate.getDate()).padStart(2, '0') === selectedDate;
                    }
                    return matchesSearch && matchesDate;
                });
            }, [logs, searchTerm, selectedDate]);

            const formatShortDate = (timestamp) => {
                const date = new Date(timestamp);
                const weekDays = ['일', '월', '화', '수', '목', '금', '토'];
                return date.getFullYear().toString().slice(2) + '.' + String(date.getMonth() + 1).padStart(2, '0') + '.' + String(date.getDate()).padStart(2, '0') + ' (' + weekDays[date.getDay()] + ') ' + String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0');
            };

            return (
                <div className="max-w-6xl mx-auto space-y-6">
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><Icons.FileText className="mr-2 text-blue-600" />치료 이력 조회</h2>
                        <div className="flex flex-col md:flex-row gap-4">
                            <div className="relative flex-grow"><input type="text" placeholder="검색..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base" /><Icons.Search className="absolute left-3.5 top-3.5 text-gray-400 w-5 h-5" /></div>
                            <div className="relative min-w-[200px]"><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700" />{selectedDate && <button onClick={() => setSelectedDate('')} className="absolute right-3 top-3.5 text-gray-400 hover:text-red-500"><Icons.XCircle size={18} /></button>}</div>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        {filteredLogs.length === 0 ? <div className="p-12 text-center text-gray-400"><Icons.FileText className="w-12 h-12 mx-auto mb-3 opacity-20" /><p className="text-lg">검색 결과가 없습니다.</p></div> : 
                        <div className="overflow-x-auto"><table className="w-full text-left border-collapse">
                            <thead><tr className="bg-gray-50 border-b border-gray-200 text-gray-500 text-sm uppercase tracking-wider"><th className="px-4 py-4 font-semibold whitespace-nowrap w-auto">날짜 / 시간</th><th className="px-4 py-4 font-semibold whitespace-nowrap min-w-[100px]">환자명</th><th className="px-4 py-4 font-semibold text-center whitespace-nowrap w-16">베드</th><th className="px-4 py-4 font-semibold whitespace-nowrap w-32">치료 부위</th><th className="px-4 py-4 font-semibold">치료 내용</th><th className="px-4 py-4 font-semibold w-1/4">메모</th><th className="px-4 py-4 font-semibold text-center whitespace-nowrap w-16">관리</th></tr></thead>
                            <tbody className="divide-y divide-gray-100">{filteredLogs.map(log => (
                                <tr key={log.id} className="hover:bg-blue-50/30 transition-colors">
                                    <td className="px-4 py-4 text-gray-600 text-sm whitespace-nowrap"><div className="flex items-center"><Icons.Calendar size={14} className="mr-2 text-gray-400" /><span className="font-mono tracking-tight">{formatShortDate(log.date)}</span></div></td>
                                    <td className="px-4 py-4 whitespace-nowrap"><div className="flex items-center font-bold text-gray-800"><Icons.User size={16} className="mr-2 text-blue-500" />{log.patientName}</div></td>
                                    <td className="px-4 py-4 text-center"><div className="inline-flex items-center justify-center bg-gray-100 text-gray-600 px-2 py-1 rounded font-mono text-sm"><Icons.BedDouble size={14} className="mr-1" />{log.bedId}</div></td>
                                    <td className="px-4 py-4 text-sm font-medium text-gray-700 whitespace-nowrap">{log.treatmentArea || <span className="text-gray-300">-</span>}</td>
                                    <td className="px-4 py-4"><div className="flex flex-wrap gap-1.5">{log.treatments.map((t, i) => <span key={i} className="inline-block px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded border border-blue-100">{t}</span>)}{log.treatments.length === 0 && <span className="text-gray-400 text-xs">-</span>}</div></td>
                                    <td className="px-4 py-4 text-sm text-gray-600 break-words">{log.memo || <span className="text-gray-300">-</span>}</td>
                                    <td className="px-4 py-4 text-center"><button onClick={(e) => { e.stopPropagation(); onDelete(log.id); }} className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors"><Icons.Trash2 size={18} /></button></td>
                                </tr>
                            ))}</tbody>
                        </table></div>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentView, setCurrentView] = useState('dashboard');
            
            const [beds, setBeds] = useState(() => {
                const saved = localStorage.getItem('clinic_beds_v1');
                if (saved) try { return JSON.parse(saved); } catch(e){}
                return Array.from({ length: TOTAL_BEDS }, (_, i) => ({ id: i + 1, patientName: '', memo: '', treatmentArea: '', treatments: [] }));
            });

            const [chunaQueues, setChunaQueues] = useState(() => {
                const saved = localStorage.getItem('clinic_chuna_v1');
                if (saved) try { return JSON.parse(saved); } catch(e){}
                return [{ id: 1, patients: [] }];
            });

            const [consultationQueues, setConsultationQueues] = useState(() => {
                const saved = localStorage.getItem('clinic_consultation_v1');
                if (saved) try { return JSON.parse(saved); } catch(e){}
                return [{ id: 1, patients: [] }];
            });

            const [doctorQueue, setDoctorQueue] = useState(() => {
                const saved = localStorage.getItem('clinic_doctor_queue_v1');
                if (saved) try { return JSON.parse(saved); } catch(e){}
                return [];
            });

            const [patientRecords, setPatientRecords] = useState(() => {
                const saved = localStorage.getItem('clinic_patient_records_v1');
                if (saved) try { return JSON.parse(saved); } catch(e){}
                return {};
            });

            const [treatmentLogs, setTreatmentLogs] = useState(() => {
                const saved = localStorage.getItem('clinic_treatment_logs_v1');
                if (saved) try { return JSON.parse(saved); } catch(e){}
                return [];
            });

            useEffect(() => localStorage.setItem('clinic_beds_v1', JSON.stringify(beds)), [beds]);
            useEffect(() => localStorage.setItem('clinic_chuna_v1', JSON.stringify(chunaQueues)), [chunaQueues]);
            useEffect(() => localStorage.setItem('clinic_consultation_v1', JSON.stringify(consultationQueues)), [consultationQueues]);
            useEffect(() => localStorage.setItem('clinic_doctor_queue_v1', JSON.stringify(doctorQueue)), [doctorQueue]);
            useEffect(() => localStorage.setItem('clinic_patient_records_v1', JSON.stringify(patientRecords)), [patientRecords]);
            useEffect(() => localStorage.setItem('clinic_treatment_logs_v1', JSON.stringify(treatmentLogs)), [treatmentLogs]);

            const logTreatment = useCallback((bed) => {
                if (!bed.patientName) return;
                const newLog = { id: Date.now() + '-' + Math.random(), patientName: bed.patientName, bedId: bed.id, date: Date.now(), treatments: bed.treatments.map(t => t.name), treatmentArea: bed.treatmentArea, memo: bed.memo };
                setTreatmentLogs(prev => [newLog, ...prev]);
            }, []);

            const savePatientHistory = useCallback((bed) => {
                if (!bed.patientName) return;
                setPatientRecords(prev => ({ ...prev, [bed.patientName]: { name: bed.patientName, memo: bed.memo, treatmentArea: bed.treatmentArea, treatmentNames: bed.treatments.map(t => t.name), lastVisit: Date.now() } }));
            }, []);

            const handleUpdateBed = (updatedBed) => {
                setBeds(prev => prev.map(b => {
                    if (b.id === updatedBed.id) {
                        if (b.patientName && !updatedBed.patientName) {
                            savePatientHistory(b);
                            logTreatment(b);
                        }
                        return updatedBed;
                    }
                    return b;
                }));
            };

            const handleCompleteDoctorTreatment = (item) => {
                setDoctorQueue(prev => prev.filter(q => q.id !== item.id));
                setBeds(prev => prev.map(bed => bed.id === item.bedId ? { ...bed, treatments: bed.treatments.map(t => t.name === item.treatmentName && t.status === TreatmentStatus.WAITING ? { ...t, status: TreatmentStatus.IN_PROGRESS, startTime: Date.now() } : t) } : bed));
            };

            const handleAdmitPatient = (bedId, patientName, sourceId) => {
                const history = patientRecords[patientName];
                let treatments, memo = '', treatmentArea = '';
                if (history) {
                    memo = history.memo || ''; treatmentArea = history.treatmentArea || '';
                    treatments = history.treatmentNames.map(name => createTreatment(name, !TREATMENTS.DEFAULT.some(def => name.startsWith(def))));
                    if (treatments.length === 0) treatments = generateDefaultTreatments();
                } else { treatments = generateDefaultTreatments(); }
                
                setBeds(prev => prev.map(b => b.id === bedId ? { ...b, patientName, startTime: Date.now(), treatments, memo, treatmentArea } : b));
                setConsultationQueues(prev => prev.map(q => ({ ...q, patients: q.patients.filter(p => p.id !== sourceId) })));
            };

            const activePatients = beds.filter(b => b.patientName).length;
            const activeChuna = chunaQueues[0]?.patients.length || 0;
            const activeConsult = consultationQueues[0]?.patients.length || 0;
            const activeDoctor = doctorQueue.length;

            return (
                <div className="min-h-screen bg-slate-100 flex flex-col">
                    <header className="bg-white shadow-sm sticky top-0 z-50">
                        <div className="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-8">
                                <div className="flex items-center space-x-3"><div className="bg-blue-600 p-2 rounded-lg"><Icons.Activity className="text-white w-6 h-6" /></div><h1 className="text-xl font-bold text-gray-800 tracking-tight">한의원 치료 현황판</h1></div>
                                <nav className="flex space-x-1 bg-slate-100 p-1 rounded-lg">
                                    <button onClick={() => setCurrentView('dashboard')} className={`flex items-center px-4 py-2 rounded-md text-sm font-medium transition-all ${currentView === 'dashboard' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><Icons.LayoutDashboard className="w-4 h-4 mr-2" />대시보드</button>
                                    <button onClick={() => setCurrentView('history')} className={`flex items-center px-4 py-2 rounded-md text-sm font-medium transition-all ${currentView === 'history' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}><Icons.History className="w-4 h-4 mr-2" />치료 이력</button>
                                </nav>
                            </div>
                            {currentView === 'dashboard' && (
                                <div className="flex items-center space-x-4">
                                    <div className="hidden md:flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                                        <Icons.Users className="w-4 h-4 text-slate-500" />
                                        <span className="text-sm font-medium text-slate-600">치료실: <span className="text-blue-600 font-bold">{activePatients}</span><span className="mx-2 text-slate-300">|</span>상담: <span className="text-orange-600 font-bold">{activeConsult}</span><span className="mx-2 text-slate-300">|</span>원장치료: <span className="text-indigo-600 font-bold">{activeDoctor}</span><span className="mx-2 text-slate-300">|</span>추나: <span className="text-purple-600 font-bold">{activeChuna}</span></span>
                                    </div>
                                    <div className="hidden sm:flex text-xs text-gray-400 space-x-3"><span className="flex items-center"><span className="w-2 h-2 rounded-full bg-red-400 mr-1"></span> 대기</span><span className="flex items-center"><span className="w-2 h-2 rounded-full bg-green-400 mr-1"></span> 완료</span><span className="flex items-center"><span className="w-2 h-2 rounded-full bg-gray-800 mr-1"></span> 안함</span></div>
                                </div>
                            )}
                        </div>
                    </header>
                    <main className="flex-grow p-4 sm:p-6">
                        <div className="max-w-[1920px] mx-auto">
                            {currentView === 'dashboard' ? (
                                <div className="flex flex-col xl:flex-row gap-6">
                                    <div className="flex-grow grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                        {beds.map(bed => <div key={bed.id} className="min-h-[400px] h-full"><BedCard bed={bed} onUpdate={handleUpdateBed} onAdmitPatient={handleAdmitPatient} getPatientRecord={name => patientRecords[name] || null} /></div>)}
                                    </div>
                                    <div className="w-full xl:w-[320px] 2xl:w-[380px] flex flex-col gap-6 xl:h-[calc(100vh-8rem)] xl:sticky xl:top-24">
                                        <div className="flex-[2] min-h-[250px]"><DoctorQueueCard queue={doctorQueue} onUpdate={setDoctorQueue} onCompleteItem={handleCompleteDoctorTreatment} /></div>
                                        <div className="flex-1 min-h-[200px]">{consultationQueues[0] && <ConsultationQueueCard queue={consultationQueues[0]} onUpdate={q => setConsultationQueues([q])} />}</div>
                                        <div className="flex-1 min-h-[200px]">{chunaQueues[0] && <ChunaQueueCard queue={chunaQueues[0]} onUpdate={q => setChunaQueues([q])} />}</div>
                                    </div>
                                </div>
                            ) : (
                                <HistoryView logs={treatmentLogs} onDelete={id => setTreatmentLogs(prev => prev.filter(l => l.id !== id))} />
                            )}
                        </div>
                    </main>
                    <footer className="text-center py-6 text-gray-400 text-sm"><p>© 2024 Clinic Treatment Dashboard.</p></footer>
                </div>
            );
        };

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (e) {
            console.error(e);
            throw e; // 위쪽의 window.onerror로 전파
        }
    </script>
</body>
</html>